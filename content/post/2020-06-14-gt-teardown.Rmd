---
title: gt teardown
author: Michael
date: '2020-06-14'
slug: gt-teardown
categories:
  - r
tags:
  - r
  - teardown
draft: true
---

```{r setup, include = FALSE}
library(tidyverse)
library(gt)
```


## Introduction

I love open source software.
I love the intentions behind it, I love the range of tools available and I love the community.
But for me, the best thing about open source is spotting something impressive and being able to find out how it was done.

Reading the source written by a better^[more experienced, more knowledgable etc] programmer to learn from is such a powerful tool to improve your own code.
I'm an okay programmer, I get by, but I want to be better. 
In this post, I'm going to have a close look at some R code from the [gt](https://gt.rstudio.com/) package^[I'm using version `r packageVersion("gt")`].
This is one of the many R pacakges for generating publication-quality html tables and is written by Richard Iannone^[[github](https://github.com/rich-iannone), [twitter](https://twitter.com/riannone)].
Iannone is behind some great R packages, and he writes some of the best documentation for his packages that I have ever seen. 
Seriously, it's better than software I pay for. 

## gt

Very quickly, gt makes html tables. 
It stands for 'grammar of tables' and borrows an idea familiar to most R programmers of a grammar to do something: ggplot2 is a grammar of graphics.

This method of design leads to packages which containing many small functions that are composable into a larger whole.
The same way a ggplot2 graphic is built up from smaller pieces linked together; or more loosely similar to how our natural language builds complex sentences from simple building blocks following a set of rules.

gt lets us go from this:

```{r echo=FALSE}
pizzaplace %>%
  select(-id) %>%
  group_by(type, size) %>%
  summarise(n_sold = n(), price = sum(price))
```

to this:

```{r, echo=FALSE}
pizzaplace %>%
  select(-id) %>%
  group_by(type, size) %>%
  summarise(n_sold = n(), price = sum(price)) %>%
  ungroup() %>% 
  gt(groupname_col = "type") %>%
  # gt() %>% 
  fmt_currency(columns = "price") %>% 
  fmt_number(columns = "n_sold", sep_mark = ",", decimals = 0) %>% 
  tab_source_note("Data taken from the pizzaplace dataset of {gt}") %>% 
  tab_footnote(footnote = "Includes Hawaiian pizzas", location = cells_row_groups("classic"))
```

It can do a lot more, and I fully encourrage you to check out the documentation and examples [here](https://gt.rstudio.com/).

## Where it all starts: `gt()`

All gt tables start by calling the `gt()` function on a data frame.
This creates a `gt_tbl` object, which is essentially a fancy list.
Classes in R are not quite the same as classes in, say, Python.
The methods of making classes and structring inheritance are beyond this post^[I'd recommend Hadley Wickham's [Advanced R](https://adv-r.hadley.nz/oo.html) for more information].
But here's the class information for our `gt` object:

```{r}
gt_table_1 <- gt(pizzaplace)

class(gt_table_1)
```

We can tell from this that while our object is a `gt_tbl` object primarily, it's based on a `list`.
This is good for us: We can use all the normal tools for dealing with lists to get a better idea about this `gt_tbl` object.

Let's have a look what's inside:

```{r}
str(gt_table_1, max.level = 1)
```

So we see that a single call to `gt()` has done quite a bit of work behind the scenes.

The reason for constructing this object as a list lets the user add formatting etc in any order that they like.
All the main functions from gt accept a `gt_tbl` object as their first argument and return a modified version of that `gt_tbl` object.
This means that gt is highly pipeable^[using the magritter pipes common in the tidyverse: `%>%`], and we can build up complex tables in small steps.

Thsi is similar to the tidyverse/dplyr philosophy: all the functions accept and return the same class meaning that they can be used in any order and are pipeable.

We see from the above that we've got 16 items that can be altered using gt functions.
From a quick glance, some of these match different bits of the "Parts of a *gt* table" picture in the documentation:

- boxhead
- stub
- heading
- spanners
- footnotes
- source_notes

Interestingly, we also carry a copy of the underlying data in `_data`:

```{r}
all(gt_table_1$`_data` == pizzaplace)
```

The `gt()` function itself

(GO INTO THE DETAILS OF THE CONSTRUCTION, MAYBE MAKE A GRAPH OF THE INITIALISATION AND A DEEPISH DIVE INTO A SIMPLE ONE)
(DELETE THIS CODE LISTING AFTER)

```{r eval=FALSE, include=TRUE}
function (data, rowname_col = "rowname", groupname_col = dplyr::group_vars(data), 
    rownames_to_stub = FALSE, auto_align = TRUE, id = NULL, row_group.sep = getOption("gt.row_group.sep", 
        " - ")) 
{
    validate_table_id(id)
    if (rownames_to_stub) {
        rowname_col <- "__GT_ROWNAME_PRIVATE__"
    }
    if (length(groupname_col) == 0) {
        groupname_col <- NULL
    }
    if (!is.null(rowname_col) && !is.null(groupname_col) && any(rowname_col %in% 
        groupname_col)) {
        stop("The value \"", rowname_col, "\" appears in both `rowname_col` and ", 
            "`groupname_col`. These arguments must not have any values in common.", 
            call. = FALSE)
    }
    data <- list() %>% dt_data_init(data_tbl = data, rownames_to_column = if (rownames_to_stub) 
        rowname_col
    else NA_character_) %>% dt_boxhead_init() %>% dt_stub_df_init(rowname_col = rowname_col, 
        groupname_col = groupname_col, row_group.sep = row_group.sep) %>% 
        dt_row_groups_init() %>% dt_stub_others_init() %>% dt_heading_init() %>% 
        dt_spanners_init() %>% dt_stubhead_init() %>% dt_footnotes_init() %>% 
        dt_source_notes_init() %>% dt_formats_init() %>% dt_styles_init() %>% 
        dt_summary_init() %>% dt_options_init() %>% dt_transforms_init() %>% 
        dt_has_built_init()
    if (!is.null(id)) {
        data <- data %>% dt_options_set_value(option = "table_id", 
            value = id)
    }
    class(data) <- c("gt_tbl", class(data))
    if (isTRUE(auto_align)) {
        data <- data %>% cols_align(align = "auto")
    }
    data
}
```

(LOOK AT SOME OF THE SIMPLE ELEMENTS OF THE gt_tbl LIST)
(MAKE A NEW gt_table WHICH HAS THE GROUP ROWS SET)
(COMPARE THE TWO)
(ADD MORE FEATURES OF THE TABLE AND COMPARE THE CHANGES, WHERE POSSIBLE LOOK AT THE ACTUAL SOURCE CODE USED IN THE FUNCTIONS)
(TALK ABOUT THE PRINT GENERIC)

(END WITH A CONCLUSION/SUMMARY OF THE MAIN TECHNIQUES 
  ((MAKING AN OBJECT)
   (SETTING EVERYTHING UP READY)
   (MAKING SIMPLE FUNCTIONS THAT ACCEPT THE OBJECT DO ONE THING AND SEND IT ON ITS WAY)
   (BUILDING OFF AN EXISTING OBJECT)
   ()))